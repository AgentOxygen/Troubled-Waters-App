<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Troubled Waters | California Hydroclimate Model Agreement</title>
	<link href='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css' rel='stylesheet' />
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
	<style>
		.metric_grid {
			border: 1px solid #fff;
			overflow: hidden;
			transition: all .3s linear;
		}
		.metric:hover img {
			transform: scale(1.1);
			transition: all .2s linear;
		}
		.metric-row-margin { 
			margin-top: 1.0em; 
		}
		.regions_dropdown {
			height: 20vh;
			overflow: auto;
		}
		.row.row-no-margin {
			margin-left: 0px;
			margin-right: 0px;
		}

		.col-no-padding {
			padding-left: 0 !important;
			padding-right: 0 !important;
		}
		.info-header {
			white-space:nowrap;
			font-weight: bold;
		}
	</style>
  </head>
  <body>
	
	<div class="metric_grid text-center" id="metric_selection">
		<div class="row align-items-start metric-row-margin">
			<div class="col">
				<a class="metric" href="#" onclick="switchToMapAndControls('frac_extreme')">
					<img id="frac_extreme" class="img-thumbnail" src="images/frac_extreme.png" alt="Δ Fraction of Yearly Precipitation on Extreme Days">
				</a>
			</div>
			<div class="col">
				<a class="metric" href="#" onclick="switchToMapAndControls('max_threeday_precip')">
					<img id="max_threeday_precip" class="img-thumbnail" src="images/max_threeday_precip.png" alt="Δ Maximum Three-day Precipitation">
				</a>
			</div>
			<div class="col">
				<a class="metric" href="#" onclick="switchToMapAndControls('nov_mar_percent')">
					<img id="nov_mar_percent" class="img-thumbnail" src="images/nov_mar_percent.png" alt="Δ Fraction of Yearly Precipitation between November-March">
				</a>
			</div>
		</div>
		<div class="row align-items-center metric-row-margin">
			<div class="col">
				<a class="metric" href="#" onclick="switchToMapAndControls('rainfall_ratio')">
					<img id="rainfall_ratio" class="img-thumbnail" src="images/rainfall_ratio.png" alt="Δ Ratio of Yearly Precipitation as Rain vs Snow">
				</a>
			</div>
			<div class="col">
				<a class="metric" href="#" onclick="switchToMapAndControls('num_ros_events')">
					<img id="num_ros_events" class="img-thumbnail" src="images/num_ros_events.png" alt="Δ Number of Rain-On-Snow Days">
				</a>
			</div>
			<div class="col">
				<a class="metric" href="#" onclick="switchToMapAndControls('norm_rain_on_snow')">
					<img id="norm_rain_on_snow" class="img-thumbnail" src="images/norm_rain_on_snow.png" alt="Δ Normalized Number of Rain-On-Snow Days">
				</a>
			</div>
		</div>
		<div class="row align-items-end metric-row-margin">
			<div class="col">
				<a class="metric" href="#" onclick="switchToMapAndControls('SWE_total')">
					<img id="SWE_total" class="img-thumbnail" src="images/SWE_total.png" alt="Δ Cumulative Snow Water Equivalent">
				</a>
			</div>
			<div class="col">
				<a class="metric" href="#" onclick="switchToMapAndControls('et')">
					<img id="et" class="img-thumbnail" src="images/et.png" alt="Δ Evapotranspiration">
				</a>
			</div>
		</div>
	</div>
	
	<button id="back_to_metric_sel_btn" type="button" class="btn btn-primary" onclick="switchToMetricSelection()" style="display:none">←Back to Metric Selection</button>
	
	<div class="container" id="map_and_controls">
		<div class="row">
			<div class="col">
				<div class="row row-no-margin">
					<div class="col-xs-12 col-sm-6 col-no-padding">
						<!-- Mapbox tag !-->
						<div id='map' style='width: 40vw; height: 60vh'></div>
					</div>
					<div class="col-xs-12 col-sm-6 col-no-padding">
						<img id="colorbar" src="" class="img-fluid" style='height: 60vh' alt="Map colorbar">
					</div>
				</div>
			</div>
			<div class="col">
				<div class="card p-3 m-2">
					<div class="row m-1" id="toolbar_row">
						<div class="btn-group btn-group-toggle" data-toggle="buttons">
							<div class="btn-group me-2" role="group" aria-label="Shapefile Buttons">
								<div class="btn-group">
									<button id="shp_california" type="button" class="btn btn-outline-primary" onclick="changeRegion('shp_california', 'shp_california', 'california', 'California')">
										<span class="sr-only">California</span>
									</button>
								</div>
								<div class="btn-group">
									<button id="shp_gwbasins" type="button" class="btn btn-outline-primary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										<span class="sr-only">Groundwater Basins</span>
									</button>
									<div class="dropdown-menu" id="drpdwn_gw">
										<!-- Server function to populate these dynamically !-->
										<div id="gw_dropdown_menu" class="regions_dropdown"></div>
										<div class="dropdown-divider"></div>
										<a class="dropdown-item" href="#">All Basins</a>
									</div>
								</div>
								<div class="btn-group">
									<button type="button" class="btn btn-outline-primary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										<span class="sr-only">Watersheds</span>
									</button>
									<div class="dropdown-menu">
										<div id="ws_dropdown_menu" class="regions_dropdown"></div>
										<div class="dropdown-divider"></div>
									<a class="dropdown-item" href="#">All Watersheds</a>
									</div>
								</div>
								<div class="btn-group">
									<button type="button" class="btn btn-outline-primary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										<span class="sr-only">Counties</span>
									</button>
									<div class="dropdown-menu">
										<div id="counties_dropdown_menu" class="regions_dropdown"></div>
										<div class="dropdown-divider"></div>
										<a class="dropdown-item" href="#">All Counties</a>
									</div>
								</div>
								<div class="btn-group">
									<button type="button" class="btn btn-outline-primary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										<span class="sr-only">Places</span>
									</button>
									<div class="dropdown-menu">
										<div id="places_dropdown_menu" class="regions_dropdown"></div>
										<div class="dropdown-divider"></div>
										<a class="dropdown-item" href="#">All Places</a>
									</div>
								</div>
							</div>
							<div class="btn-group me-3 btn-group-toggle" data-toggle="buttons">
								<label onclick="switchRCP(85)" class="btn btn-outline-secondary active">
									<input type="radio" style="display:none" autocomplete="off" checked>
									RCP 8.5
								</label>
								<label onclick="switchRCP(45)" class="btn btn-outline-secondary">
									<input type="radio" style="display:none" autocomplete="off">
									RCP 4.5
								</label>
							</div>
						</div>
					</div>
					<div class="row" id="info_row" style="p-3">
						<div id="display_card" class="card">
							<p>
							<span id="metric_name_display" class="info-header"></span> for <span id="region_name_display" class="info-header"></span> under the <span id="rcp_display" class="info-header"></span> Scenario
							</p>
						</div>
						<div class="col">
							<div id="model_agreement_info" class="row">
								agreement info
							</div>
							<div id="model_value_info" class="row">
								value info
							</div>
							<div id="model_list_info" class="row">
								model list info
							</div>
						</div>
						<div class="col">
							<div id="cali_model_agreement_info" class="row">
								whole state agreement
							</div>
							<div id="cali_model_value_info" class="row">
								whole state value
							</div>
							<div id="cali_model_list_info" class="row">
								whole state model info
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

  
	<!--
	<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
	<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
	!-->
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

	<script src='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js'></script>
	<script type="application/javascript">
		server_link = "http://localhost:8000/"
	
		metric = "et";
		rcp = 85;
		region = "";
		shp_file = "";
		dataset_labels_name = "";
		
		active_btnID = "";
		active_btngrpID = "";
		
		/**===================== MapBox API stuff ===================== **/
		// Load the map
		mapboxgl.accessToken = 'pk.eyJ1Ijoib3h5Z2VuMSIsImEiOiJja25jMmh3b28wenFlMnFvaGowN3B6bmc1In0.MKaFBCRkpp4gZWA3hIT-iA';
		const map = new mapboxgl.Map({
			container: 'map', // container ID
			// Choose from Mapbox's core styles, or make your own style with Mapbox Studio
			style: 'mapbox://styles/mapbox/light-v10',
			center: [-122.486052, 37.830348],
			zoom: 4.9
		});
		
		function getColorbarImgURL(){
			return `${server_link}get_colorbar_img?name=${metric}`
		}
		
		function getOverlayImgURL(){
			return `${server_link}get_raster_img?name=${metric}_RCP${rcp}`
		}
		
		function getOverlayImgDict(){
			data = {
				'type': 'image',
				'url': getOverlayImgURL(),
				'coordinates': [
					// Top Left, Top Right, Bottom Right, Bottom Left
					[-124.63125, 43.63875],[-113.30625, 43.63875],[-113.30625, 31.36375],[-124.63125, 31.36375]
			]}
			return data;
		}
		
		// Add metric overlay, update source to change which overlay
		map.on('load', () => {
			map.addSource('metric_overlay', getOverlayImgDict());
			map.addLayer({
				id: 'metric_overlay-layer',
				'type': 'raster',
				'source': 'metric_overlay',
				'paint': {
					'raster-fade-duration': 0,
					'raster-opacity': 0.8
				}
			});
		});
		
		/**================ End of Mapbox API Stuff ================**/
		// Populate the drop-downs
		fetch(`${server_link}/formatted/region_dropdowns?ds=frac_extreme_RCP45_GWB&lvar=basin_name`)
			.then((response) => {
				return response.text();
			}).then(function (html) {
				document.getElementById("gw_dropdown_menu").innerHTML = html;
			});
		fetch(`${server_link}/formatted/region_dropdowns?ds=frac_extreme_RCP45_WBD&lvar=wbd_name`)
			.then((response) => {
				return response.text();
			}).then(function (html) {
				document.getElementById("ws_dropdown_menu").innerHTML = html;
			});
		fetch(`${server_link}/formatted/region_dropdowns?ds=frac_extreme_RCP45_COUNTIES&lvar=county_name`)
			.then((response) => {
				return response.text();
			}).then(function (html) {
				document.getElementById("counties_dropdown_menu").innerHTML = html;
			});
		fetch(`${server_link}/formatted/region_dropdowns?ds=frac_extreme_RCP45_PLACES&lvar=place_name`)
			.then((response) => {
				return response.text();
			}).then(function (html) {
				document.getElementById("places_dropdown_menu").innerHTML = html;
			});
		
		function switchRCP(rcpNumber){
			console.log("Switching to RCP " + rcpNumber.toString());
			rcp = rcpNumber;
			// Update raster overlay
			map.getSource('metric_overlay').updateImage(getOverlayImgDict());
			// Update colorbar
			document.getElementById("colorbar").src = getColorbarImgURL();
			// Update display
			if (rcp == 85){
				document.getElementById("rcp_display").innerHTML = "High Emissions (RCP 8.5)";
			} else {
				document.getElementById("rcp_display").innerHTML = "Medium Emissions (RCP 4.5)";
			}
			updateMetricInfo();
		}
		
		function switchShapefile(shapefileName){
			console.log("Switching to shapefile " + shapefileName);
			shp_file = shapefileName;
			if (shp_file = "GWB"){
				dataset_labels_name = "basin_name";
			}else if(shp_file = "WBD"){
				dataset_labels_name = "wbd_name";
			}else if(shp_file = "COUNTIES"){
				dataset_labels_name = "counties_name";
			}else if(shp_file = "PLACES"){
				dataset_labels_name = "places_name";
			}
		}
		
		function changeRegion(btnID, btngrpID, shapefileName, regionName){
			switchShapefile(shapefileName);
			console.log("Changing region to " + regionName);
			region = regionName;
			if (active_btnID != ""){
				$("#" + active_btnID).button('toggle');
			}
			if (active_btngrpID != "") {
				$("#" + active_btngrpID).button('toggle');
			}
			active_btnID = btnID;
			active_btngrpID = btngrpID;
			$("#" + btnID).button('toggle');
			$("#" + btngrpID).button('toggle');
			// Update region display
			document.getElementById("region_name_display").innerHTML = regionName;
			updateMetricInfo();
		}
		
		function switchToMapAndControls(selected_metric){
			metric = selected_metric;
			console.log("Hiding metric selection and moving to map with metric=" + metric);
			// Updating group visibilities
			document.getElementById("metric_selection").style.display = "none";
			document.getElementById("map_and_controls").style.display = "block";
			document.getElementById("back_to_metric_sel_btn").style.display = "block";
			// Update raster overlay
			map.getSource('metric_overlay').updateImage(getOverlayImgDict());
			// Update colorbar
			document.getElementById("colorbar").src = getColorbarImgURL();
			// Update metric name display
			document.getElementById("metric_name_display").innerHTML = document.getElementById(metric).alt;
			updateMetricInfo();
		}
		
		function switchToMetricSelection(){
			console.log("Switching back to metric selection")
			document.getElementById("metric_selection").style.display = "block";
			document.getElementById("map_and_controls").style.display = "none";
			document.getElementById("back_to_metric_sel_btn").style.display = "none";
		}
		
		function updateMetricInfo(){
			fetch(`${server_link}/get_region_info?ds=${metric}_RCP${rcp}_${shp_file}&var=${dataset_labels_name}&var_key=${region}`).then((response) => {
				return response.text();
			}).then(function (json) {
				console.log(json);
			});
		}
		
		// Load defaults
		map.on('load', () => {
			switchToMapAndControls("et");
			changeRegion("shp_california", "shp_california", "california", "California");
			switchRCP(85);
		});
		
	</script>
  </body>
</html>